<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="上篇主要讲解Redis命令和Jredis命令时的基本使用。下篇主要包括：SpringBoot整合Redis、redis.conf配置文件解析、持久化（RDB、AOF）、发布订阅、主从复制、缓存穿透和雪崩">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis笔记（下）">
<meta property="og:url" content="http://example.com/2022/06/06/Redis%E7%AC%94%E8%AE%B0%E4%B8%8B%E7%AF%87/index.html">
<meta property="og:site_name" content="Live For Code">
<meta property="og:description" content="上篇主要讲解Redis命令和Jredis命令时的基本使用。下篇主要包括：SpringBoot整合Redis、redis.conf配置文件解析、持久化（RDB、AOF）、发布订阅、主从复制、缓存穿透和雪崩">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619001106568.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619003517742.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619131043137.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619131442924.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619131552862.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619154512402.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619155611662.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619170109839.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619220011092.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619220539552.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619220758129.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619225553163.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619225917218.png">
<meta property="og:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619234105563.png">
<meta property="article:published_time" content="2022-06-06T06:17:35.000Z">
<meta property="article:modified_time" content="2022-06-21T14:59:04.522Z">
<meta property="article:author" content="Li Honghao">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/89635/AppData/Roaming/Typora/typora-user-images/image-20220619001106568.png">

<link rel="canonical" href="http://example.com/2022/06/06/Redis%E7%AC%94%E8%AE%B0%E4%B8%8B%E7%AF%87/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Redis笔记（下） | Live For Code</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Live For Code</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">代码改变世界</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/06/Redis%E7%AC%94%E8%AE%B0%E4%B8%8B%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar1.gif">
      <meta itemprop="name" content="Li Honghao">
      <meta itemprop="description" content="C++、Java、MySQL、Linux、安全、BMC">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Live For Code">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis笔记（下）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-06 14:17:35" itemprop="dateCreated datePublished" datetime="2022-06-06T14:17:35+08:00">2022-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-21 22:59:04" itemprop="dateModified" datetime="2022-06-21T22:59:04+08:00">2022-06-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
            </span>

          
            <span id="/2022/06/06/Redis%E7%AC%94%E8%AE%B0%E4%B8%8B%E7%AF%87/" class="post-meta-item leancloud_visitors" data-flag-title="Redis笔记（下）" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/06/06/Redis%E7%AC%94%E8%AE%B0%E4%B8%8B%E7%AF%87/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/06/06/Redis%E7%AC%94%E8%AE%B0%E4%B8%8B%E7%AF%87/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <div class="post-description">上篇主要讲解Redis命令和Jredis命令时的基本使用。下篇主要包括：SpringBoot整合Redis、redis.conf配置文件解析、持久化（RDB、AOF）、发布订阅、主从复制、缓存穿透和雪崩</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="SpringBoot整合Redis"><a href="#SpringBoot整合Redis" class="headerlink" title="SpringBoot整合Redis"></a>SpringBoot整合Redis</h1><p>Springboot操作数据，都封装在spring-data中：jpa、jdbc、MongoDB、redis</p>
<p>SpringData也适合SpringBoot齐名的项目。</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://spring.io/">https://spring.io/</a></p>
<p><strong>说明：在Springboot2.x之后原来使用的Jredis被替换为了lettuce</strong></p>
<p>jedis：采用的是直连方式，多核线程操作的话，是不安全的，如果想要避免不安全，使用jedis pool连接池</p>
<p>lettuce：	采用netty，实例可以再多个线程中共享，不存在线程不安全的问题。</p>
<p><strong>源码分析：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RedisOperations.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RedisProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(name = &quot;redisTemplate&quot;)</span><span class="comment">//我们可以自定义个redisTemplate替换默认配置</span></span><br><span class="line">   <span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">   <span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">      <span class="comment">// 默认的RedisTemplate 没有过多的设置，redis对象都是需要序列化的</span></span><br><span class="line">      <span class="comment">//两个泛型都是Object，Object的类型，我们后续需要强制转换为 &lt;String,Object&gt;</span></span><br><span class="line">      RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">      template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">      <span class="keyword">return</span> template;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean</span><span class="comment">//String是redis常用的方式，因此提出，&lt;Strng,String&gt; 的Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">   <span class="keyword">public</span> StringRedisTemplate <span class="title function_">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringRedisTemplate</span>(redisConnectionFactory);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>RedisProperties.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.redis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Database index used by the connection factory.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> <span class="variable">database</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Connection URL. Overrides host, port, and password. User is ignored. Example:</span></span><br><span class="line"><span class="comment">    * redis://user:password@example.com:6379</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Redis server host.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Login username of the redis server.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Login password of the redis server.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Redis server port.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">6379</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Whether to enable SSL support.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">boolean</span> ssl;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Read timeout.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> Duration timeout;</span><br><span class="line">   </span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="整合测试："><a href="#整合测试：" class="headerlink" title="整合测试："></a>整合测试：</h2><p>1、导入依赖（Spring自动导入）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--操作Redis，底层是spring-data-redis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、配置连接</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SpringBoot 所有的配置类，都有一个自动配置类  RedisAutoConfiguration</span></span><br><span class="line"><span class="comment"># 自动配置类都会绑定一个 properties 配置文件  RedisProperties</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#配置 redis</span></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">192.168.222.128</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br></pre></td></tr></table></figure>

<p>3、测试</p>
<h1 id="redis-conf详解"><a href="#redis-conf详解" class="headerlink" title="redis.conf详解"></a>redis.conf详解</h1><p>redis启动时，通过该配置文件启动，阅读配置文件，简单分析：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1、redis-server redis.conf   	运行命令</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section"># 2、单位换算设置；大小写不敏感 </span></span><br><span class="line"><span class="section"># 1k =&gt; 1000 bytes</span></span><br><span class="line"><span class="section"># 1kb =&gt; 1024 bytes</span></span><br><span class="line"><span class="section"># 1m =&gt; 1000000 bytes</span></span><br><span class="line"><span class="section"># 1mb =&gt; 1024<span class="emphasis">*1024 bytes</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># 1g =&gt; 1000000000 bytes</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># 1gb =&gt; 1024*</span>1024<span class="emphasis">*1024 bytes</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section"># include：</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># 	include /path/redis.conf	可以包含其他配置文件</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section"># NETWORK：</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># 	bind ip_address				绑定IP地址</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	protected-mode yes			保护模式</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># 	port 6379					端口设置</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">################################# GENERAL #####################################</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># GENERAL：</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># 	daemonize no 				#以守护进程的方式运行</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	pidfile /var/run/redis_6379.pid	#如果以后台方式运行， 就需要指定一个pid文件</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># 	loglevel notice				#日志级别</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#   logfile &quot;&quot;					#生成的日志文件</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	databases 16				#默认的数据数量</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	always-show-logo yes		#是否显示logo</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">################################ SNAPSHOTTING  ################################</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># SNAPSHOTTING:	#规定时间内执行了多少次，则会持久化 .rdb .aof</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># redis是内存数据库，没有持久化断电即逝</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	save 900 1					#900秒内，如果key至少修改一次，进行持久化操作	</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	save 300 10					#300秒以内，至少修改10次，进行持久化操作</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	save 60 10000</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	stop-writes-on-bgsave-error yes	#持久化出错，是否继续工作</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	rdbcompression yes			#是否压缩rdb文件，需要消耗CPU资源</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	rdbchecksum yes				是否校验RDB文件</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	dbfilename dump.rdb			rdb保存文件路径</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">################################# REPLICATION #################################</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># 主从复制的时候在进行分析</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">################################## SECURITY ###################################</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># 可以在这里设置redis的密码</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	requirepass foobared		配置foobared，就是设置密码</span></span></span><br><span class="line"><span class="emphasis"><span class="section">#	命令模式下 get reqirepass password  set requirepass password</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section"># maxclients 10000				最大客户端连接数</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># maxmemory <span class="language-xml"><span class="tag">&lt;<span class="name">bytes</span>&gt;</span></span>				Redis配置最大内存</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># maxmemory-policy noeviction	内存到达上限之后的策略</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">############################## APPEND ONLY MODE ###############################</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># appendonly no					默认是不开启aof的，默认是rdb方式持久化的，在大部分情况下，rdb完全够用</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># appendfilename &quot;appendonly.aof&quot;		aof默认的文件</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># appendfsync always			每次修改都会同步，性能低</span></span></span><br><span class="line"><span class="emphasis"><span class="section">appendfsync everysec			每一秒执行一次同步，丢失1秒的数据</span></span></span><br><span class="line"><span class="emphasis"><span class="section"># appendfsync no				不执行同步</span></span></span><br></pre></td></tr></table></figure>



<h1 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h1><p>Redis是内存数据库，如果不将内存中的数据库状态保存到磁盘中，那么一旦服务器进程退出，服务器中的数据将会消失。所以redis提供了持久化功能。</p>
<h2 id="RDB（Redis-DataBase）"><a href="#RDB（Redis-DataBase）" class="headerlink" title="RDB（Redis DataBase）"></a>RDB（Redis DataBase）</h2><blockquote>
<p>什么是RDB</p>
</blockquote>
<p><strong>在指定的时间间隔内，将内存中的数据及快照写入磁盘。也就是行话的snapshot快照。它恢复时是将快照文件读到内存中。</strong></p>
<p><strong>Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，带持久化过程都结束了，再用这个临时文件代替上次持久化好的文件。整个过程中，主进程是不进行任何IO操作的。这就确保了极高的性能。如果需要进行大规模的数据恢复，且对于数据恢复的完整性不是非常敏感，那么RDB方式要比AOF方式更加高效。RDB的缺点是最后一次持久化的数据可能丢失。默认情况下就是RDB方式。</strong></p>
<p><img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619001106568.png" alt="image-20220619001106568"></p>
<p>因为是代替上次的RDB文件，因此持久化文件中的数据一直就是最新的。</p>
<p><strong>RDB保存的文件是：dump.rdb</strong></p>
<blockquote>
<p>RDB的配置内容如下：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################ SNAPSHOTTING  ################################</span></span><br><span class="line"><span class="comment">#配置持久化规则</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">stop-writes-on-bgsave-error <span class="built_in">yes</span></span><br><span class="line"><span class="comment">#配置rdb文件是否压缩</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line"><span class="comment">#配置是否校验</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br><span class="line"><span class="comment">#配置文件名</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"><span class="comment">#配置文件保存路径</span></span><br><span class="line"><span class="built_in">dir</span> ./</span><br></pre></td></tr></table></figure>



<blockquote>
<p>触发机制</p>
</blockquote>
<p>1、save规则满足的情况下，会自动触发rdb规则</p>
<p>2、退出redis，也会触发rdb规则</p>
<p>备份完毕之后，就会生成dump.rdb文件</p>
<blockquote>
<p>演示触发生成rdb文件，并记录数据</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">bmc@ubuntu:~/myconfig$ redis-server redis.conf		<span class="comment">#启动redis</span></span><br><span class="line">12224:C 18 Jun 2022 09:02:26.796 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">12224:C 18 Jun 2022 09:02:26.796 <span class="comment"># Redis version=5.0.14, bits=64, commit=00000000, modified=0, pid=12224, just started</span></span><br><span class="line">12224:C 18 Jun 2022 09:02:26.796 <span class="comment"># Configuration loaded</span></span><br><span class="line">bmc@ubuntu:~/myconfig$ redis-cli -p 6379			<span class="comment">#客户端连接</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name lihonghao					<span class="comment">#设置name</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name							<span class="comment">#查看name</span></span><br><span class="line"><span class="string">&quot;lihonghao&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SHUTDOWN							<span class="comment">#直接关闭服务</span></span><br><span class="line">not connected&gt; <span class="built_in">exit</span></span><br><span class="line">bmc@ubuntu:~/myconfig$ redis-server redis.conf		<span class="comment">#启动服务</span></span><br><span class="line">12231:C 18 Jun 2022 09:03:07.029 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">12231:C 18 Jun 2022 09:03:07.029 <span class="comment"># Redis version=5.0.14, bits=64, commit=00000000, modified=0, pid=12231, just started</span></span><br><span class="line">12231:C 18 Jun 2022 09:03:07.029 <span class="comment"># Configuration loaded</span></span><br><span class="line">bmc@ubuntu:~/myconfig$ redis-cli -p 6379			<span class="comment">#连接</span></span><br><span class="line">127.0.0.1:6379&gt; get name							<span class="comment">#查看name</span></span><br><span class="line"><span class="string">&quot;lihonghao&quot;</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>如何恢复rdb文件？</p>
</blockquote>
<p>1、只需将rdb文件放在redis启动目录下，redis启动的时候会自动检查dump.rdb，恢复其中的数据。</p>
<p>2、查看启动目录，也就是配置文件的目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get <span class="built_in">dir</span></span><br><span class="line">1) <span class="string">&quot;dir&quot;</span></span><br><span class="line">2) <span class="string">&quot;/home/bmc/myconfig&quot;</span>	<span class="comment">#在配置文件的目录下</span></span><br></pre></td></tr></table></figure>



<p><strong>优点：</strong></p>
<ul>
<li>大规模数据时，效率非常高</li>
<li>对数据完整性要求不高</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要一定的时间间隔进行操作，如果reids宕机了，最后一次修改数据就没有了</li>
<li>fork进程的时候会占用内存空间</li>
</ul>
<h2 id="AOF（Append-Only-File）"><a href="#AOF（Append-Only-File）" class="headerlink" title="AOF（Append Only File）"></a>AOF（Append Only File）</h2><p>将我们的所有命令都记录下来，history，恢复的时候把这个文件全部在执行一遍。</p>
<p><strong>以日志的形式记录每个写操作（只有写操作对数据的改变起作用），将Redis执行过的所有指令记录下来（读操作不记录），之追加文件但是不可以写文件，redis启动之初会读取文件重新构建数据，换言之，redis重启的话，就根据日志的内容将写指令从前到后执行一次，已完成数据的恢复。</strong></p>
<ul>
<li><strong>AOF保存的文件是：appendonly.aof文件</strong></li>
</ul>
<p><img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619003517742.png" alt="image-20220619003517742"></p>
<p><strong>配置文件内容：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################## APPEND ONLY MODE ###############################</span></span><br><span class="line">appendonly no			<span class="comment">#默认是不开启的，需要配置为 yes</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span>		<span class="comment">#aof文件名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># appendfsync always			#配置修改的频率</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># appendfsync no</span></span><br><span class="line"></span><br><span class="line">no-appendfsync-on-rewrite no	<span class="comment">#是否开启新的文件进行写</span></span><br><span class="line">auto-aof-rewrite-percentage 100	<span class="comment">#重写文件的进度</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb	<span class="comment">#重写文件的最小值</span></span><br><span class="line">aof-load-truncated <span class="built_in">yes</span></span><br><span class="line">aof-use-rdb-preamble <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>



<p><strong>如果aof配置文件被修改，失效，redis是无法启动的，这时候Redis提供了一个工具：</strong></p>
<p><strong>redis-check-aof</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-check-aof --fix appendonly.aof</span><br></pre></td></tr></table></figure>

<p>重新启动redis服务，即可恢复数据。</p>
<p><strong>优点：</strong></p>
<ul>
<li>每次修改都可以同步，文件完整性可以更加好</li>
<li>每秒同步一次，可能会丢失一秒的数据</li>
<li>从不同步，效率是最高的</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>相对于数据文件来说，aof远大于rdb，修复速度也比rdb慢</li>
<li>运行效率也比rdb慢，</li>
</ul>
<h1 id="Redis发布订阅"><a href="#Redis发布订阅" class="headerlink" title="Redis发布订阅"></a>Redis发布订阅</h1><p>Redis 发布订阅 （pub&#x2F;sub） 是一种消息订阅模式：发布者（pub）发布消息，订阅者接收消息（sub）。</p>
<p>Redis可以订阅任意数量的频道。</p>
<p>类似微信、微博、等关注系统。</p>
<p>1、消息发送者</p>
<p>2、频道</p>
<p>3、消息订阅者</p>
<p><strong>发布订阅消息图：</strong></p>
<p><img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619131043137.png" alt="image-20220619131043137"></p>
<p>下图展示了频道channel1，以及订阅这个频道的三个客户端，—client1   —-client2      —-client3之间的关系：</p>
<img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619131442924.png" alt="image-20220619131442924" style="zoom:50%;" />

<p>当有新消息通过PUBLISH 命令发送给频道 channel1 时，这个消息就会被推送给订阅它的三个客户端。</p>
<img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619131552862.png" alt="image-20220619131552862" style="zoom:50%;" />



<blockquote>
<p>命令</p>
</blockquote>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>publish channel message</td>
<td>将消息发布到频道</td>
</tr>
<tr>
<td>subscribe channel</td>
<td>客户端订阅一个频道</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>测试</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#订阅lihonghao 频道</span></span><br><span class="line">127.0.0.1:6379&gt; SUBSCRIBE lihonghao</span><br><span class="line">Reading messages... (press Ctrl-C to quit)		<span class="comment">#等待接收发布的信息</span></span><br><span class="line">1) <span class="string">&quot;subscribe&quot;</span></span><br><span class="line">2) <span class="string">&quot;lihonghao&quot;</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br><span class="line">1) <span class="string">&quot;message&quot;</span>					<span class="comment">#接收到信息</span></span><br><span class="line">2) <span class="string">&quot;lihonghao&quot;</span>					<span class="comment">#那个频道的消息</span></span><br><span class="line">3) <span class="string">&quot;hello world&quot;</span>				<span class="comment">#频道发布的具体内容</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; PUBLISH lihonghao <span class="string">&quot;hello world&quot;</span>		<span class="comment">#向频道中发布信息</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>原理</p>
</blockquote>
<p>Redis是用C实现的。</p>
<p>通过SUBSCRIBE命令订阅某频道后，redis-server里维护了一个字典，字典的键就是一个个channel，而字典 的值则是一个链表，链表中记录了所有订阅这个channel的客户端。subscribe命令的关键就是将客户端添加到channel的订阅链表中。</p>
<p>通过publish命令发布消息后，redis-server会使用给定的频道作为建，在他维护的字典中查找这个channel的所有客户端链表。遍历这个链表，将消息发布给订阅者。</p>
<h1 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>主从复制，是指将一台redis服务器上的数据复制到其他的 redis 服务器，前者称为主节点，后者称为从节点。数据的复制是单向的，只能由主节点到从节点。Master以写为主，Slave以读为主。</p>
<p>默认情况下，每台redis服务器都是主节点；且一个主节点可以有多个从节点，但是一个从节点只能有一个主节点。</p>
<p>主从复制的作用主要包括：</p>
<ul>
<li>数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式之一。</li>
<li>故障恢复：当主节点出现问题时，可以有从节点提供服务，实现快速的故障恢复，实际上是一种服务的冗余。</li>
<li>负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，从节点提供写服务，（即redis应用写数据时连接主节点，读数据时连接从节点），分担服务器负载，尤其是在写少读多的情况下，通过多个从节点分担读负载，可以大大提高redis服务器的并发量。</li>
<li>高可用基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此主从复制是redis高可用的基础。</li>
</ul>
<p>一般来说，要将redis运用于工程项目中，只使用一台redis是不行的，原因如下：</p>
<p>1、从结构看，单台服务器会发生单点故障，并且一台服务器需要处理所有请求的请求负载，压力较大。</p>
<p>2、从容量上，单个redis服务内存容量有限，就算一台redis服务器内存容量为256G，也不能将所有内存用作Redis内存，一般来说，单台redis做大使用内存不应该超过20G</p>
<img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619154512402.png" alt="image-20220619154512402" style="zoom:50%;" />



<p>主从复制，读写分离！80%的情况下都是在进行读操作。减缓服务器的压力！架构中经常使用，一主二从！</p>
<p>在公司中都是用主从复制！</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>只配置从库，不用配置主库！</p>
<p>redis服务默认都是主库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication					<span class="comment">#查看当前的库的信息</span></span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master		<span class="comment">#角色</span></span><br><span class="line">connected_slaves:0		<span class="comment">#丛机</span></span><br><span class="line">master_replid:f35a2519310ff2c2f53625c430f85b1ca28e38c4</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>



<p>说明：如果在虚拟机中，一台机器中，要配置集群环境，要修改配置文件。因为要启动多个redis服务，就要将多个redis服务器的端口号、PID文件名、日志文件、dump文件等配置信息修改，避免冲突！</p>
<p>1、启动四个客户端连接（四个linux终端）。</p>
<p><img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619155611662.png" alt="image-20220619155611662"></p>
<p>2、赋值三个配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bmc@ubuntu:~/myconfig$ <span class="built_in">ls</span></span><br><span class="line">dump.rdb  redis.conf</span><br><span class="line">bmc@ubuntu:~/myconfig$ <span class="built_in">cp</span> redis.conf redis79.conf</span><br><span class="line">bmc@ubuntu:~/myconfig$ <span class="built_in">cp</span> redis.conf redis80.conf</span><br><span class="line">bmc@ubuntu:~/myconfig$ <span class="built_in">cp</span> redis.conf redis81.conf</span><br><span class="line">bmc@ubuntu:~/myconfig$ <span class="built_in">ls</span></span><br><span class="line">dump.rdb  redis79.conf  redis80.conf  redis81.conf  redis.conf</span><br></pre></td></tr></table></figure>

<p>3、分别修改三个配置文件中的内容：（vim，i 编辑，wq 保存退出， &#x2F;keyword 查找），同样修改其他文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">port 6380		<span class="comment">#修改端口号</span></span><br><span class="line">pidfile /var/run/redis_6380.pid		<span class="comment">#修改pid文件问自己的文件</span></span><br><span class="line">logfile <span class="string">&quot;6380.log&quot;</span>		<span class="comment">#修改日志文件</span></span><br><span class="line">dbfilename dump6380.rdb			<span class="comment">#修改dump文件</span></span><br></pre></td></tr></table></figure>

<p>4、启动三个服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bmc@ubuntu:~/myconfig$ redis-server redis79.conf		<span class="comment">#启动第一个redis</span></span><br><span class="line">14626:C 19 Jun 2022 01:06:19.214 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">14626:C 19 Jun 2022 01:06:19.214 <span class="comment"># Redis version=5.0.14, bits=64, commit=00000000, modified=0, pid=14626, just started</span></span><br><span class="line">14626:C 19 Jun 2022 01:06:19.214 <span class="comment"># Configuration loaded</span></span><br><span class="line"></span><br><span class="line">bmc@ubuntu:~/myconfig$ redis-server redis80.conf		<span class="comment">#启动第二个redis</span></span><br><span class="line"></span><br><span class="line">bmc@ubuntu:~/myconfig$ redis-server redis81.conf		<span class="comment">#启动第三个redis</span></span><br><span class="line"></span><br><span class="line">bmc@ubuntu:~/myconfig$ ps -aux | grep redis				<span class="comment">#查看启动的redis服务</span></span><br><span class="line">bmc       14627  0.1  0.0  54228  3712 ?        Ssl  01:06   0:00 redis-server 127.0.0.1:6379</span><br><span class="line">bmc       14636  0.1  0.0  54228  3812 ?        Ssl  01:06   0:00 redis-server 127.0.0.1:6380</span><br><span class="line">bmc       14647  0.1  0.0  54228  3680 ?        Ssl  01:07   0:00 redis-server 127.0.0.1:6381</span><br><span class="line">bmc       14654  0.0  0.0  14432  1092 pts/2    S+   01:07   0:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

<p>在三个终端中启动客户端连接redis服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">bmc@ubuntu:~/myconfig$ redis-cli -p 6381		<span class="comment">#连接redis服务，查看信息，每个redis服务都是主机</span></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:1b8c1377ad99fe9339c1933bbd2a581fe352ada1</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br><span class="line">bmc@ubuntu:~/myconfig$ redis-cli -p 6379			<span class="comment">#连接Redis服务，每个redis服务默认是主机</span></span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:c1b5107a4369630e99b0f0ce02563c89b1e78dc7</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>



<h2 id="一主二从模型："><a href="#一主二从模型：" class="headerlink" title="一主二从模型："></a>一主二从模型：</h2><p><strong>默认情况下，所有的redis服务都是主节点。</strong></p>
<p><strong>一般情况下只需要配置从机即可：认一个老大：一主（79）二从（80、81）</strong></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Slaveof host port</td>
<td>从属于某个主机下的redis服务</td>
</tr>
</tbody></table>
<blockquote>
<p>演示：</p>
<p>当前使用主从配置是在配置文件中配置的，当前使用时命令，只是暂时的。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例如在redis80下的客户端连接中执行：</span></span><br><span class="line">127.0.0.1:6380&gt; SLAVEOF 127.0.0.1 6379			<span class="comment">#从属于当前主机上的6379服务</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; info replication				<span class="comment">#查看信息</span></span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave										<span class="comment">#角色：从机</span></span><br><span class="line">master_host:127.0.0.1							<span class="comment">#从属服务的IP</span></span><br><span class="line">master_port:6379								<span class="comment">#从属服务的端口号</span></span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:0</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:14</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:cb1bd63135740c2889a5ad339a30ea34a871b653</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:14</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:14</span><br><span class="line"></span><br><span class="line"><span class="comment">#在6381的客户端执行：</span></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:10</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:574</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:cb1bd63135740c2889a5ad339a30ea34a871b653</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:574</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:505</span><br><span class="line">repl_backlog_histlen:70</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#此时，在查看主机的info：（6379服务的信息）</span></span><br><span class="line">127.0.0.1:6379&gt; info replication				<span class="comment">#查看信息</span></span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master								<span class="comment">#主</span></span><br><span class="line">connected_slaves:2						<span class="comment">#2 个从</span></span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=518,lag=0		<span class="comment">#从机信息</span></span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=518,lag=0</span><br><span class="line">master_replid:cb1bd63135740c2889a5ad339a30ea34a871b653</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:518</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:518</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>配置文件配置：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################# REPLICATION #################################</span></span><br><span class="line"><span class="comment"># replicaof &lt;masterip&gt; &lt;masterport&gt;			配置附属于主机的信息</span></span><br><span class="line"><span class="comment"># masterauth &lt;master-password&gt;				如果主机有密码，可以输入密码</span></span><br></pre></td></tr></table></figure>



<p><strong>注意：</strong></p>
<ul>
<li><p>主机可以读写，从机只读，主机中的数据会被赋值到从机中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#主机：</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name lihonghao		<span class="comment">#主机写</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name				<span class="comment">#主机读</span></span><br><span class="line"><span class="string">&quot;lihonghao&quot;</span></span><br><span class="line"><span class="comment">#从机：</span></span><br><span class="line">127.0.0.1:6380&gt; get name				<span class="comment">#从机读</span></span><br><span class="line"><span class="string">&quot;lihonghao&quot;</span></span><br><span class="line">127.0.0.1:6380&gt; <span class="built_in">set</span> name zhangsan		<span class="comment">#从机写失败</span></span><br><span class="line">(error) READONLY You can<span class="string">&#x27;t write against a read only replica.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主机突然宕机（会产生dump.rdb文件，会对数据进行持久化），从机所属主机的信息还是该主机，只是当前没有了写操作，从机只读。<strong>并且，从机依旧可以读取到主机所写入的信息</strong>。当主机从新运行时，还是和原来的环境一样。<strong>更改及的情况是，主机宕机之后，应该从从机中算一个作为主机。</strong></p>
</li>
<li><p>因为刚才是命令行方式配置的从机，如果这是从机关闭，所有配置是失效了，不再是从机了，就不能在读取到主机的信息了。重新配置之后，又可以读取主机中所有的信息。<strong>所以使用配合问价进行配置</strong></p>
</li>
</ul>
<blockquote>
<p>复制原理：</p>
</blockquote>
<p>slave启动成功后连接到master后会发送一个sync同步命令。</p>
<p>master接收到命令，启动后台存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master将传递整个数据文件到slave，并完成一次同步。</p>
<ul>
<li>全量赋值：slave在接受到数据库文件之后，将其存盘并加载到内存中。</li>
<li>增量复制：Master继续将新接收到的所有修改命令一次传递给slave，完成同步</li>
</ul>
<p>只要slave重新连接master，一次全量复制将会被执行。</p>
<h2 id="链式模型："><a href="#链式模型：" class="headerlink" title="链式模型："></a>链式模型：</h2><p>Master —— Slave —– Slave</p>
<p><img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619170109839.png" alt="image-20220619170109839"></p>
<p>配置方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#81执行：</span></span><br><span class="line">SLAVEOF localhost 6380			<span class="comment">#81从属80</span></span><br><span class="line"><span class="comment">#80执行：</span></span><br><span class="line">SLAVEOF localhost 6379			<span class="comment">#80从属79</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>如果没有了Master，这时能不能选取80slave作为新的老大呢？</p>
</blockquote>
<p><strong>谋曹篡位</strong>	</p>
<p>如果主机宕机了，可以执行命令：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>slaveof no one</td>
<td>不从属于任何主机，是自己变为主机</td>
</tr>
</tbody></table>
<p>其他的节点就可以主动连接到自己！（手动执行）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; SLAVEOF no one				<span class="comment"># 80 执行该命令</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; info replication			<span class="comment">#展示信息</span></span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master						<span class="comment">#变为主机	</span></span><br><span class="line">connected_slaves:1					<span class="comment">#自己有一个从机81</span></span><br><span class="line">slave0:ip=127.0.0.1,port=6381,state=online,offset=2571,lag=0</span><br><span class="line">master_replid:7ae3b653d387388e5117d948cc180fa90dbfaad9</span><br><span class="line">master_replid2:c3f0a0be8839c4b0c3869561c37c06f786e31396</span><br><span class="line">master_repl_offset:2571</span><br><span class="line">second_repl_offset:2558</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:2571</span><br></pre></td></tr></table></figure>

<p>如果此时，79主机修复了。那就只能从新配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof localhost 6379</span><br></pre></td></tr></table></figure>

<p>此时就是链路模型。</p>
<h2 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h2><blockquote>
<p>概述</p>
</blockquote>
<p>主从切换的技术方法是：当服务器宕机后，需要手动把一台服务器切换为主服务器，这就需要人工干预。但是这需要人力，时间成本。</p>
<p>通常使用哨兵模式，Redis从2,8以后正式提供了sentinel（哨兵）架构来解决这个问题。</p>
<p>自动实现主机的切换，能够后台监控主机是否出现故障，如果出现故障了，根据投票数，<strong>自动将从库切换为主库</strong></p>
<p>哨兵模式是一种特殊的模式，首先redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，他会独立执行。<strong>其原理是哨兵通过发送命令，等待redis服务响应，从而监控运行的多个redis实例</strong></p>
<img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619220011092.png" alt="image-20220619220011092" style="zoom:50%;" />

<p><strong>哨兵的可执行程序在安装目录下，是：redis-sentinel</strong></p>
<p><strong>哨兵的作用：</strong></p>
<ul>
<li>通过发送命令，监控redis主从服务器</li>
<li>当哨兵检测到master宕机时，会自动将slave切换为master，然后通过发布订阅模式，通知其他服务器，修改配置文件，让它切换所属的主机。</li>
</ul>
<p>然而，一个哨兵可能会出现问题，因此，才用过多个哨兵进行监控，个哨兵之间也能相互监控。形成多哨兵模式。</p>
<img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619220539552.png" alt="image-20220619220539552" style="zoom:50%;" />

<p><img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619220758129.png" alt="image-20220619220758129"></p>
<blockquote>
<p>测试 </p>
</blockquote>
<p>目前状态是一主二从</p>
<p>1、创建哨兵配置文件，配置哨兵配置文件 sentinel.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#哨兵，监视 名称 主机 端口 投票机制</span></span><br><span class="line">sentinel monitor myredis 127.0.0.1 6379 1`</span><br><span class="line"><span class="comment">#1代表主机挂了，采用投票方式选取主机，票数最多的作为主机。</span></span><br></pre></td></tr></table></figure>

<p>2、启动哨兵</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel sentinel.conf <span class="comment">#启动哨兵</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动结果</span></span><br><span class="line">bmc@ubuntu:~/myconfig$ redis-sentinel sentinel.conf</span><br><span class="line">15347:X 19 Jun 2022 07:17:01.168 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">15347:X 19 Jun 2022 07:17:01.168 <span class="comment"># Redis version=5.0.14, bits=64, commit=00000000, modified=0, pid=15347, just started</span></span><br><span class="line">15347:X 19 Jun 2022 07:17:01.168 <span class="comment"># Configuration loaded</span></span><br><span class="line">15347:X 19 Jun 2022 07:17:01.169 * Increased maximum number of open files to 10032 (it was originally <span class="built_in">set</span> to 1024).</span><br><span class="line">                _._</span><br><span class="line">           _.-``__ <span class="string">&#x27;&#x27;</span>-._</span><br><span class="line">      _.-``    `.  `_.  <span class="string">&#x27;&#x27;</span>-._           Redis 5.0.14 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">&#x27;&#x27;</span>-._</span><br><span class="line"> (    <span class="string">&#x27;      ,       .-`  | `,    )     Running in sentinel mode</span></span><br><span class="line"><span class="string"> |`-._`-...-` __...-.``-._|&#x27;</span>` _.-<span class="string">&#x27;|     Port: 26379</span></span><br><span class="line"><span class="string"> |    `-._   `._    /     _.-&#x27;</span>    |     PID: 15347</span><br><span class="line">  `-._    `-._  `-./  _.-<span class="string">&#x27;    _.-&#x27;</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|</span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |           http://redis.io</span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|</span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |</span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span></span><br><span class="line">      `-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span></span><br><span class="line">          `-._        _.-<span class="string">&#x27;</span></span><br><span class="line"><span class="string">              `-.__.-&#x27;</span></span><br><span class="line"></span><br><span class="line">15347:X 19 Jun 2022 07:17:01.171 <span class="comment"># Sentinel ID is 80a9719691a9429502c31216e8c574b122e62596</span></span><br><span class="line">15347:X 19 Jun 2022 07:17:01.171 <span class="comment"># +monitor master myredis 127.0.0.1 6379 quorum 1</span></span><br><span class="line">15347:X 19 Jun 2022 07:17:01.174 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6379</span><br><span class="line">15347:X 19 Jun 2022 07:17:01.175 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3、模拟主机宕机，查看结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 6379redis服务执行：</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name yanhongwei</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">&quot;yanhongwei&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment">#	此时查看 6381redis服务，已经变为主机</span></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=42083,lag=0		<span class="comment">#并且80是当前的从机</span></span><br><span class="line">master_replid:08fb9bcc70604b912269daf682b63886b20078be</span><br><span class="line">master_replid2:c3f0a0be8839c4b0c3869561c37c06f786e31396</span><br><span class="line">master_repl_offset:42083</span><br><span class="line">second_repl_offset:41387</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2558</span><br><span class="line">repl_backlog_histlen:39526</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看哨兵进程日志，发现主机从 6379redis服务切换为了 6381redis服务</span></span><br><span class="line">15347:X 19 Jun 2022 07:20:53.839 <span class="comment"># +switch-master myredis 127.0.0.1 6379 127.0.0.1 6381</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4、假如说此时 6379 redis服务修复好了，启动之后，哨兵会将该redis服务切换为 6381 的从机。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动 6379 redis服务</span></span><br><span class="line">redis-server redis79.conf</span><br><span class="line">redis-cli -p 6379</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看redis81 服务的信息：</span></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=67996,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=6379,state=online,offset=67864,lag=1		<span class="comment">#发现已经变为 81 的从机</span></span><br><span class="line">master_replid:08fb9bcc70604b912269daf682b63886b20078be</span><br><span class="line">master_replid2:c3f0a0be8839c4b0c3869561c37c06f786e31396</span><br><span class="line">master_repl_offset:67996</span><br><span class="line">second_repl_offset:41387</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2558</span><br><span class="line">repl_backlog_histlen:65439</span><br></pre></td></tr></table></figure>



<blockquote>
<p>优缺点</p>
</blockquote>
<p><strong>优点：</strong></p>
<ul>
<li>哨兵集群，基于主从复制，所有主从复制的优点，它全有</li>
<li>主从可以切换，故障可以转移，系统的可用性更好</li>
<li>哨兵模式就是主从模式的升级</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>redis不好在线扩容，集群容量一但到达上限，扩容十分麻烦</li>
<li>实现哨兵的配置十分繁琐</li>
</ul>
<h1 id="Redis缓存穿透和雪崩"><a href="#Redis缓存穿透和雪崩" class="headerlink" title="Redis缓存穿透和雪崩"></a>Redis缓存穿透和雪崩</h1><p> Redis缓存的使用，极大提升了，应用程序的性能和效率，特别是数据查询费方面。但同时，也带来一些问题。</p>
<p>其中最重要的就是<strong>数据一致性问题</strong>。严格意义上讲，这个问题是无解的。</p>
<p><strong>如果对数据一致性要求很高，就不能使用缓存。</strong></p>
<p><strong>典型问题：</strong></p>
<ul>
<li>缓存穿透</li>
<li>缓存雪崩</li>
<li>缓存击穿</li>
</ul>
<h2 id="缓存穿透（查不到数据，访问存储层）"><a href="#缓存穿透（查不到数据，访问存储层）" class="headerlink" title="缓存穿透（查不到数据，访问存储层）"></a>缓存穿透（查不到数据，访问存储层）</h2><p><strong>概念：</strong></p>
<p>缓存穿透的概念是，用户想要查询一个数据，发现redis内存数据库没有，也就是缓存没有命中，于是向持久层数据库查询，发现没有，于是查询失败。</p>
<p>当用户很多的时候，（例如秒杀场景，当缓存中没有，就要去mysql数据库中查询），于是都去请求了持久层数据库。这会给持久层造成很大的压力，这时候就相当于出现了缓存穿透。</p>
<p><strong>解决方案:</strong></p>
<ul>
<li><strong>布隆过滤器</strong></li>
<li><strong>缓存空对象</strong></li>
</ul>
<p>布隆过滤器是一种数据结构，对所有可能查询参数以hash形式存储。在控制层先进行校验，不符合则丢弃，从而避免了对底层存储系统的查询压力。</p>
<img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619225553163.png" alt="image-20220619225553163" style="zoom:50%;" />





<p>当存储层不命中后，及时返回的空对象，也将其缓存起来，同时设置一个过期时间，之后再访问这个数据库将会从缓存中获取，保护了后端数据源。</p>
<img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619225917218.png" alt="image-20220619225917218" style="zoom:50%;" />

<p>但是这种方法存在两个问题：</p>
<p>1、如果空值能够被缓存起来，这就意味着缓存需要更多的空间存储更多的键，因为这当中会有更多空值的键</p>
<p>2、即使对空值设置了时间，还是会存在缓存层和存储层的数据会有一段时间窗口的不一致。这对于需要保证一致性的业务有影响。（2.3过程中有时间占用，1过程还是会进行一部分的）</p>
<h2 id="缓存击穿（查得到，查的太多了，缓存过期）"><a href="#缓存击穿（查得到，查的太多了，缓存过期）" class="headerlink" title="缓存击穿（查得到，查的太多了，缓存过期）"></a>缓存击穿（查得到，查的太多了，缓存过期）</h2><p><strong>概述：</strong></p>
<p>缓存击穿是指，一个key非常热点，在不停的扛着大并发，大并发集中在这一个点进行访问。当key失效的瞬间，持续的大并发就穿透缓存，直接访问数据库，就像在屏障上击穿了一样。</p>
<p>当某个key在过期瞬间，有大量的请求并发访问，这类数据一般是热点数据，由于缓存过期，会同时访问数据库来查询数据，并会写缓存，会导致数据库瞬间压力增大。</p>
<p><strong>解决方案：</strong></p>
<ul>
<li><strong>设置热点数据不过期</strong><ul>
<li>不设置过期时间，就不会出现热点数据key过期失效情况。</li>
</ul>
</li>
<li><strong>加锁互斥</strong><ul>
<li>使用分布式锁，保证对于每个key同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转到了分布式锁。对分布式锁的考验很大。</li>
</ul>
</li>
</ul>
<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><p><strong>概念：</strong></p>
<p>1、在某一段时间内，缓存集体过期失效。	2、Redis宕机。对数据库的访问出现周期性的波峰。</p>
<img src="C:\Users\89635\AppData\Roaming\Typora\typora-user-images\image-20220619234105563.png" alt="image-20220619234105563" style="zoom:50%;" />



<p><strong>解决方案：</strong></p>
<ul>
<li>Redis高可用<ul>
<li>搭建集群，多设置几台Redis，主从复制，哨兵模式</li>
</ul>
</li>
<li>限流等级<ul>
<li>思想是：缓存失效后，通过加锁或者队列来控制对数据库写缓存的线程数量，比如对某个key只允许一个线程查询数据和写缓存，其他线程等待</li>
</ul>
</li>
<li>数据预热<ul>
<li>正式部署之前，提前访问热点数据。这部分大量访问的数据会提前加载到缓存中。在大并发访问之前手动加载缓存不同的key，并设置不同的过期时间，让缓存失效时间尽可能均匀。</li>
</ul>
</li>
</ul>

    </div>

    
    
    
        <div class="reward-container">
  <div>请作者喝杯奶茶吧！</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="Li Honghao 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"># Redis</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/06/05/happy/" rel="prev" title="Redis笔记（上）">
      <i class="fa fa-chevron-left"></i> Redis笔记（上）
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/06/09/%E5%AD%97%E8%8A%82%E4%B8%80%E9%9D%A21/" rel="next" title="字节一面-1">
      字节一面-1 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringBoot%E6%95%B4%E5%90%88Redis"><span class="nav-number">1.</span> <span class="nav-text">SpringBoot整合Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E5%90%88%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="nav-number">1.1.</span> <span class="nav-text">整合测试：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#redis-conf%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.</span> <span class="nav-text">redis.conf详解</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">Redis持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RDB%EF%BC%88Redis-DataBase%EF%BC%89"><span class="nav-number">3.1.</span> <span class="nav-text">RDB（Redis DataBase）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AOF%EF%BC%88Append-Only-File%EF%BC%89"><span class="nav-number">3.2.</span> <span class="nav-text">AOF（Append Only File）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="nav-number">4.</span> <span class="nav-text">Redis发布订阅</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">5.</span> <span class="nav-text">Redis主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">5.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-number">5.2.</span> <span class="nav-text">环境配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%E6%A8%A1%E5%9E%8B%EF%BC%9A"><span class="nav-number">5.3.</span> <span class="nav-text">一主二从模型：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%93%BE%E5%BC%8F%E6%A8%A1%E5%9E%8B%EF%BC%9A"><span class="nav-number">5.4.</span> <span class="nav-text">链式模型：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.5.</span> <span class="nav-text">哨兵模式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E5%92%8C%E9%9B%AA%E5%B4%A9"><span class="nav-number">6.</span> <span class="nav-text">Redis缓存穿透和雪崩</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%EF%BC%88%E6%9F%A5%E4%B8%8D%E5%88%B0%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%AE%BF%E9%97%AE%E5%AD%98%E5%82%A8%E5%B1%82%EF%BC%89"><span class="nav-number">6.1.</span> <span class="nav-text">缓存穿透（查不到数据，访问存储层）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%EF%BC%88%E6%9F%A5%E5%BE%97%E5%88%B0%EF%BC%8C%E6%9F%A5%E7%9A%84%E5%A4%AA%E5%A4%9A%E4%BA%86%EF%BC%8C%E7%BC%93%E5%AD%98%E8%BF%87%E6%9C%9F%EF%BC%89"><span class="nav-number">6.2.</span> <span class="nav-text">缓存击穿（查得到，查的太多了，缓存过期）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="nav-number">6.3.</span> <span class="nav-text">缓存雪崩</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Li Honghao"
      src="/images/avatar1.gif">
  <p class="site-author-name" itemprop="name">Li Honghao</p>
  <div class="site-description" itemprop="description">C++、Java、MySQL、Linux、安全、BMC</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/lhh-cmd" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lhh-cmd" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://dashi.163.com/login/?from=dashi" title="E-Mail → https:&#x2F;&#x2F;dashi.163.com&#x2F;login&#x2F;?from&#x3D;dashi" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/HaoStar00" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;HaoStar00" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.csdn.net/QQ896357473" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;QQ896357473" rel="noopener" target="_blank">CSDN</a>
        </li>
    </ul>
  </div>

      </div>
      
        <div>
           <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="410" height="110" src="//music.163.com/outchain/player?type=2&id=31445772&auto=1&height=66"></iframe>
        </div>
      


    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Li Honghao</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'k1olnQSil3rNzLIFw4lBw77r-gzGzoHsz',
      appKey     : 'TcdT0hN2dDHDu9qvf8Gk8ues',
      placeholder: "(～￣▽￣)～来呀！吐槽一番吧！！！",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

  
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<!-- ҳ����С���� -->
<script type="text/javascript" src="/js/clicklove.js"></script>